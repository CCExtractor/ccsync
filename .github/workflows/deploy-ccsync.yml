name: Deploy CCSync to Production

on:
  workflow_run:
    workflows: ["Build and Push Docker Images to GHCR"]
    types:
      - completed

permissions:
  contents: read

jobs:
  guard:
    name: Guard & Metadata
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    outputs:
      image_tag: ${{ steps.extract_sha.outputs.sha }}
    steps:
      - name: Extract commit SHA
        id: extract_sha
        run: echo "sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT

  deploy:
    name: Production Deployment
    runs-on: ubuntu-latest
    needs: guard
    env:
      IMAGE_TAG: ${{ needs.guard.outputs.image_tag }}
      DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ vars.SSH_HOST }}
          username: ${{ vars.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ vars.SSH_PORT }}
          envs: DEPLOY_PATH,IMAGE_TAG
          command_timeout: 15m
          script: |
            set -e
            sudo -u ${{ vars.DEPLOY_USER }} bash <<'EOF'
              set -e
              cd $DEPLOY_PATH

              echo "--- 1. Acquiring Deployment Lock ---"
              exec 9>/tmp/ccsync-deploy.lock
              if ! flock -n 9; then
                echo "Error: Another deployment is currently running."
                exit 1
              fi

              echo "--- 2. Validate Production Folder ---"
              test -d production || { echo "Error: production directory missing"; exit 1; }
              test -f production/docker-compose.yml || { echo "Error: docker-compose.yml missing"; exit 1; }

              echo "--- 3. Backing up current environment ---"
              if [ -f production/.env ]; then
                cp production/.env production/.env.bak
              fi

              echo "--- 4. Syncing Repository ---"
              git fetch origin main
              git reset --hard origin/main
              git clean -fd

              echo "--- 5. Pulling New Images ---"
              cd production
              echo "IMAGE_TAG=$IMAGE_TAG" > .env
              # Append secrets if needed: cat ../.env.production.secrets >> .env 

              if ! docker compose pull -q; then
                echo "Error: Docker image pull failed. Rolling back..."
                if [ -f .env.bak ]; then
                  mv .env.bak .env
                  docker compose up -d
                fi
                exit 1
              fi

              echo "--- 6. Starting Services ---"
              if ! docker compose up -d --remove-orphans; then
                echo "Deployment failed. Rolling back..."
                if [ -f .env.bak ]; then
                  mv .env.bak .env
                  docker compose up -d
                fi
                exit 1
              fi

              echo "--- 7. Running Health Checks ---"
              SUCCESS=false
              for i in {1..12}; do
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/health || echo "000")
                if [ "$HTTP_CODE" -eq 200 ]; then
                  SUCCESS=true
                  break
                fi
                echo "Attempt $i: Service not ready (HTTP $HTTP_CODE). Retrying in 5s..."
                sleep 5
              done

              if [ "$SUCCESS" = false ]; then
                echo "FATAL: Health check timed out. Initiating Rollback..."
                if [ -f .env.bak ]; then
                  mv .env.bak .env
                  docker compose up -d
                  echo "Rollback complete. Inspect logs for the failed SHA: $IMAGE_TAG"
                else
                  echo "No backup .env found. Manual intervention required!"
                fi
                exit 1
              fi

              echo "--- 8. Cleanup ---"
              docker image prune -f
              echo "Deployment of $IMAGE_TAG successful."
            EOF

      - name: Notify Failure
        if: failure()
        run: echo "Deployment failed! Check GitHub Actions logs."
        # TO DO